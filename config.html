<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>snitch config</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script>
    (function(){
      try {
        const stored = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (stored === 'dark' || (!stored && prefersDark)) {
          document.documentElement.classList.add('dark');
        }
      } catch (_) {
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          document.documentElement.classList.add('dark');
        }
      }
    })();
  </script>
</head>
<body class="bg-white text-zinc-900 dark:bg-zinc-950 dark:text-zinc-100">
  <header class="max-w-6xl mx-auto px-6 pt-10 pb-6">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">snitch config</h1>
        <p class="mt-2 text-zinc-600 dark:text-zinc-400">Edit team and project mappings in config.yml.</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="/" class="rounded-lg border border-zinc-300 px-4 py-2 text-sm text-zinc-700 hover:bg-zinc-100 dark:border-zinc-700 dark:text-zinc-200 dark:hover:bg-zinc-900">Dashboard</a>
        <button id="reload" class="rounded-lg border border-zinc-300 px-4 py-2 text-sm text-zinc-700 hover:bg-zinc-100 dark:border-zinc-700 dark:text-zinc-200 dark:hover:bg-zinc-900">Reload</button>
        <button id="save" class="rounded-lg border border-black bg-black px-4 py-2 text-sm text-white hover:translate-y-px dark:border-white dark:bg-white dark:text-zinc-900">Save</button>
        <button id="theme-toggle" class="rounded-lg border border-zinc-300 px-4 py-2 text-sm text-zinc-700 hover:bg-zinc-100 dark:border-zinc-700 dark:text-zinc-200 dark:hover:bg-zinc-900" type="button" aria-pressed="false">Dark mode</button>
      </div>
    </div>
    <div id="status" class="mt-4 text-sm"></div>
    <div class="mt-3 text-xs text-zinc-500 dark:text-zinc-400">Note: saving rewrites config.yml and removes comments.</div>
  </header>

  <main class="max-w-6xl mx-auto px-6 pb-16 space-y-10">
    <section class="rounded-xl border border-zinc-200 p-4 dark:border-zinc-800">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <h2 class="text-lg font-semibold">Team</h2>
        <div class="flex items-center gap-2">
          <label class="text-sm text-zinc-600 dark:text-zinc-400 flex items-center gap-2">
            <input id="toggle-tokens" type="checkbox" class="h-4 w-4" /> Edit tokens
          </label>
          <button id="add-user" class="rounded-lg border border-zinc-300 px-3 py-1.5 text-sm hover:bg-zinc-100 dark:border-zinc-700 dark:hover:bg-zinc-900">Add user</button>
        </div>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-xs uppercase tracking-wide text-zinc-600 dark:text-zinc-400">
            <tr>
              <th class="px-3 py-2">Display</th>
              <th class="px-3 py-2">Username</th>
              <th class="px-3 py-2">Hours/day</th>
              <th class="px-3 py-2">Days/week</th>
              <th id="token-head" class="px-3 py-2 hidden">Token</th>
              <th class="px-3 py-2"></th>
            </tr>
          </thead>
          <tbody id="team-body" class="divide-y divide-zinc-100 dark:divide-zinc-800"></tbody>
        </table>
      </div>
    </section>

    <section class="rounded-xl border border-zinc-200 p-4 dark:border-zinc-800">
      <div class="flex flex-wrap items-center gap-3 justify-between">
        <h2 class="text-lg font-semibold">Projects</h2>
        <button id="add-project" class="rounded-lg border border-zinc-300 px-3 py-1.5 text-sm hover:bg-zinc-100 dark:border-zinc-700 dark:hover:bg-zinc-900">Add project</button>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-xs uppercase tracking-wide text-zinc-600 dark:text-zinc-400">
            <tr>
              <th class="px-3 py-2">Name</th>
              <th class="px-3 py-2">ID</th>
              <th class="px-3 py-2">Time sources</th>
              <th class="px-3 py-2"></th>
            </tr>
          </thead>
          <tbody id="projects-body" class="divide-y divide-zinc-100 dark:divide-zinc-800"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    let includeTokens = false;
    let timeSources = ['userstories', 'tasks'];
    let cachedThemePreference = null;
    try {
      cachedThemePreference = localStorage.getItem('theme');
    } catch (_) {
      cachedThemePreference = null;
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function setStatus(message, kind){
      const el = document.getElementById('status');
      if (!message) { el.textContent = ''; el.className = 'mt-4 text-sm'; return; }
      const color = kind === 'error' ? 'text-red-700 dark:text-red-400' : 'text-green-700 dark:text-green-400';
      el.className = `mt-4 text-sm ${color}`;
      el.textContent = message;
    }

    function teamRow(user){
      const display = escapeHtml(user.display || '');
      const username = escapeHtml(user.username || '');
      const hours = escapeHtml(user.expected_hours_per_day ?? '');
      const days = escapeHtml(user.expected_days_per_week ?? '');
      const token = escapeHtml(user.token || '');
      return `
        <tr>
          <td class="px-3 py-2"><input data-field="display" class="w-40 rounded border border-zinc-300 px-2 py-1 dark:border-zinc-700 dark:bg-zinc-900" value="${display}" /></td>
          <td class="px-3 py-2"><input data-field="username" class="w-48 rounded border border-zinc-300 px-2 py-1 dark:border-zinc-700 dark:bg-zinc-900" value="${username}" /></td>
          <td class="px-3 py-2"><input data-field="expected_hours_per_day" type="number" step="0.25" class="w-24 rounded border border-zinc-300 px-2 py-1 dark:border-zinc-700 dark:bg-zinc-900" value="${hours}" /></td>
          <td class="px-3 py-2"><input data-field="expected_days_per_week" type="number" step="0.5" class="w-24 rounded border border-zinc-300 px-2 py-1 dark:border-zinc-700 dark:bg-zinc-900" value="${days}" /></td>
          <td class="px-3 py-2 token-cell hidden"><input data-field="token" class="w-64 rounded border border-zinc-300 px-2 py-1 dark:border-zinc-700 dark:bg-zinc-900" value="${token}" /></td>
          <td class="px-3 py-2 text-right"><button data-action="remove-user" class="text-sm text-zinc-500 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100">Remove</button></td>
        </tr>
      `;
    }

    function projectRow(project){
      const name = escapeHtml(project.name || '');
      const id = escapeHtml(project.id ?? '');
      const sources = Array.isArray(project.time_sources) ? project.time_sources : [];
      const checks = timeSources.map(source => {
        const checked = sources.includes(source) ? 'checked' : '';
        return `<label class="mr-3 inline-flex items-center gap-1 text-xs text-zinc-600 dark:text-zinc-400">
          <input data-field="source" type="checkbox" value="${source}" ${checked} /> ${source}
        </label>`;
      }).join('');
      return `
        <tr>
          <td class="px-3 py-2"><input data-field="name" class="w-56 rounded border border-zinc-300 px-2 py-1 dark:border-zinc-700 dark:bg-zinc-900" value="${name}" /></td>
          <td class="px-3 py-2"><input data-field="id" type="number" step="1" class="w-24 rounded border border-zinc-300 px-2 py-1 dark:border-zinc-700 dark:bg-zinc-900" value="${id}" /></td>
          <td class="px-3 py-2">${checks}</td>
          <td class="px-3 py-2 text-right"><button data-action="remove-project" class="text-sm text-zinc-500 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100">Remove</button></td>
        </tr>
      `;
    }

    function renderTeam(users){
      const body = document.getElementById('team-body');
      body.innerHTML = users.map(teamRow).join('');
      syncTokenVisibility();
    }

    function renderProjects(projects){
      const body = document.getElementById('projects-body');
      body.innerHTML = projects.map(projectRow).join('');
    }

    function syncTokenVisibility(){
      const head = document.getElementById('token-head');
      head.classList.toggle('hidden', !includeTokens);
      document.querySelectorAll('.token-cell').forEach(cell => {
        cell.classList.toggle('hidden', !includeTokens);
      });
    }

    async function loadConfig(){
      setStatus('Loading...', '');
      try {
        const res = await fetch(`/api/config${includeTokens ? '?include_tokens=1' : ''}`);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        timeSources = Array.isArray(data.time_sources) ? data.time_sources : timeSources;
        renderTeam((data.team && data.team.users) || []);
        renderProjects(data.projects || []);
        setStatus('', '');
      } catch (err) {
        setStatus(String(err), 'error');
      }
    }

    function collectTeam(){
      const rows = Array.from(document.querySelectorAll('#team-body tr'));
      return rows.map(row => {
        const user = {
          display: row.querySelector('[data-field="display"]').value.trim(),
          username: row.querySelector('[data-field="username"]').value.trim(),
          expected_hours_per_day: row.querySelector('[data-field="expected_hours_per_day"]').value.trim(),
          expected_days_per_week: row.querySelector('[data-field="expected_days_per_week"]').value.trim(),
        };
        if (includeTokens) {
          user.token = row.querySelector('[data-field="token"]').value.trim();
        }
        return user;
      });
    }

    function collectProjects(){
      const rows = Array.from(document.querySelectorAll('#projects-body tr'));
      return rows.map(row => {
        const sources = Array.from(row.querySelectorAll('[data-field="source"]'))
          .filter(el => el.checked)
          .map(el => el.value);
        return {
          name: row.querySelector('[data-field="name"]').value.trim(),
          id: row.querySelector('[data-field="id"]').value.trim(),
          time_sources: sources,
        };
      });
    }

    async function saveConfig(){
      setStatus('Saving...', '');
      const payload = {
        team: { users: collectTeam() },
        projects: collectProjects(),
      };
      try {
        const res = await fetch('/api/config', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error(await res.text());
        await res.json();
        setStatus('Saved.', 'ok');
      } catch (err) {
        setStatus(String(err), 'error');
      }
    }

    document.getElementById('add-user').addEventListener('click', () => {
      const body = document.getElementById('team-body');
      body.insertAdjacentHTML('beforeend', teamRow({}));
      syncTokenVisibility();
    });

    document.getElementById('add-project').addEventListener('click', () => {
      const body = document.getElementById('projects-body');
      body.insertAdjacentHTML('beforeend', projectRow({ time_sources: ['userstories'] }));
    });

    document.getElementById('team-body').addEventListener('click', (event) => {
      if (event.target && event.target.dataset.action === 'remove-user') {
        event.target.closest('tr').remove();
      }
    });

    document.getElementById('projects-body').addEventListener('click', (event) => {
      if (event.target && event.target.dataset.action === 'remove-project') {
        event.target.closest('tr').remove();
      }
    });

    document.getElementById('toggle-tokens').addEventListener('change', (event) => {
      includeTokens = event.target.checked;
      syncTokenVisibility();
      loadConfig();
    });

    document.getElementById('save').addEventListener('click', (event) => {
      event.preventDefault();
      saveConfig();
    });

    document.getElementById('reload').addEventListener('click', (event) => {
      event.preventDefault();
      loadConfig();
    });

    initTheme();
    loadConfig();

    function initTheme(){
      const toggle = document.getElementById('theme-toggle');
      if(!toggle) return;

      const media = window.matchMedia('(prefers-color-scheme: dark)');
      const preferred = cachedThemePreference || (media.matches ? 'dark' : 'light');
      applyTheme(preferred);

      toggle.addEventListener('click', ()=>{
        const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        cachedThemePreference = next;
        try {
          localStorage.setItem('theme', next);
        } catch (_) {
          // ignore storage failures
        }
        applyTheme(next);
      });

      const handleSystemChange = (event)=>{
        if(!cachedThemePreference){
          applyTheme(event.matches ? 'dark' : 'light');
        }
      };

      if(media.addEventListener){
        media.addEventListener('change', handleSystemChange);
      } else if (media.addListener){
        media.addListener(handleSystemChange);
      }

      function applyTheme(mode){
        document.documentElement.classList.toggle('dark', mode === 'dark');
        toggle.textContent = mode === 'dark' ? 'Light mode' : 'Dark mode';
        toggle.setAttribute('aria-pressed', mode === 'dark' ? 'true' : 'false');
      }
    }
  </script>
</body>
</html>
